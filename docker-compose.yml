services:
  sbpr-app:
    # テスト/E2E 用: ホストへポート公開しない（ポート競合を根絶する）
    build: .
    image: "${COMPOSE_PROJECT_NAME:-sbpr}_app_image"
    networks:
      sbpr_net:
        ipv4_address: "${SBPR_APP_IP:-172.31.0.10}"
    volumes:
      - ./local_app:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  sbpr-app-public:
    # ブラウザアクセス用: ホストへポート公開する（必要なら SBPR_PORT で変更）
    image: "${COMPOSE_PROJECT_NAME:-sbpr}_app_image"
    build: .
    ports:
      - "${SBPR_PORT:-8082}:80"
    networks:
      - sbpr_net
    volumes:
      - ./local_app:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  sbpr-test:
    build:
      context: .
      dockerfile: Dockerfile.test
    environment:
      - SBPR_PORT=${SBPR_PORT:-8082}
      - E2E_APP_IP=${SBPR_APP_IP:-172.31.0.10}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - sbpr_net
    volumes:
      - ./local_app:/app/local_app
      - ./tools:/app/tools
      - ./docs:/app/docs
    depends_on:
      - sbpr-app

networks:
  sbpr_net:
    driver: bridge
    ipam:
      config:
        - subnet: "${SBPR_SUBNET:-172.31.0.0/24}"
