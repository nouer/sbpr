# 要件定義書

## 1. はじめに
### 1.1 目的
本ドキュメントは、シンプル血圧測定記録アプリケーション（以下、sbpr）の構築に関する要件を定義するものである。本システムは、ユーザーが日常的に測定した血圧（最高血圧・最低血圧）および脈拍数を簡単に記録し、あとから確認・可視化できることを目的とする。

### 1.2 背景
高血圧は自覚症状が少なく、日常的な血圧管理が重要である。紙の記録や専用アプリはあるが、シンプルさとデータポータビリティ（エクスポート/インポート）を兼ね備えたWebアプリは少ない。本システムでは、ブラウザ上で完結するオフラインファースト設計により、サーバー不要で個人データの管理を可能にする。

## 2. システム概要
* **システム形態**: Webブラウザ上で動作するSingle Page Application (SPA)。
* **特徴**:
    * サーバーサイドでの処理を行わず、全てJavaScriptによるクライアントサイド処理で完結する。
    * データはブラウザのIndexedDBに保存し、サーバーへのデータ送信を一切行わない。
    * JSON形式でのエクスポート/インポートにより、データのバックアップ・移行が可能。
    * グラフによる血圧推移の可視化機能を提供する。

## 3. 機能要件

### 3.1 血圧記録機能
ユーザーが測定した血圧データを入力・保存する。
* **入力項目**:
    * 測定日時（デフォルトは現在日時、手動変更可）
    * 最高血圧（収縮期血圧, mmHg）: 必須
    * 最低血圧（拡張期血圧, mmHg）: 必須
    * 脈拍数（bpm）: 任意
    * 気分（3段階選択: 良い/普通/悪い）: 任意
    * 体調（3段階選択: 良い/普通/悪い）: 任意
    * 体重（kg）: 任意
    * メモ: 任意（服薬状況、体調など自由記述）
* **バリデーション**:
    * 最高血圧: 50〜300の整数
    * 最低血圧: 30〜200の整数
    * 脈拍数: 30〜250の整数（入力時）
    * 体重: 20.0〜300.0（小数点1桁まで、入力時）
    * 最高血圧 > 最低血圧であること
* **保存先**: ブラウザのIndexedDB

### 3.2 記録一覧表示機能
保存された血圧記録を一覧表示する。
* **表示項目**: 測定日時、最高血圧、最低血圧、脈拍数、気分、体調、体重、メモ
* **ソート**: 測定日時の新しい順（デフォルト）
* **フィルタ**: 日付範囲での絞り込み
* **削除**: 個別削除、全件削除
* **編集**: 既存記録の編集機能

### 3.3 グラフ表示機能
血圧の推移をグラフで可視化する。
* **グラフ種類**: 折れ線グラフ
* **表示データ**: 最高血圧、最低血圧、脈拍数（トグルで切替可）
* **期間選択**: 直近7日、30日、90日、全期間、カスタム範囲
* **正常値ライン**: 最高血圧135mmHg、最低血圧85mmHgの基準線を表示
* **レスポンシブ**: スマートフォンでも見やすいサイズに調整

### 3.4 データエクスポート機能
記録データをJSON形式でファイルに出力する。
* **出力形式**: JSON
* **ファイル名**: `sbpr_export_YYYYMMDD_HHMMSS.json`
* **内容**: 全記録データ + メタ情報（エクスポート日時、バージョン）

### 3.5 データインポート機能
エクスポートしたJSONファイルを読み込み、データを復元する。
* **読み込み形式**: JSON（エクスポート形式と互換）
* **マージ戦略**: 既存データとのマージ（IDベースで重複排除）
* **バリデーション**: インポートデータの形式チェック
* **確認ダイアログ**: インポート前に件数の確認を表示

### 3.6 統計表示機能
* **平均値**: 選択期間の最高/最低血圧・脈拍の平均
* **最高/最低**: 選択期間の最大値・最小値
* **朝/夜の比較**: 測定時間帯による分類（将来拡張）

### 3.7 AI診断機能
OpenAI APIを利用し、血圧測定記録に基づいた簡易的な健康アドバイスを提供する。
* **API Key管理**: 設定タブでユーザーが自身のOpenAI API Keyを入力・保存（localStorage）できる。
* **タブ表示条件**: API Keyが設定されている場合のみ「AI診断」タブがナビゲーションに表示される。
* **プロンプト構築**: 以下の情報を自動的に含めたプロンプトを生成する。
    * 全測定記録データ（日時、最高/最低血圧、脈拍、気分、体調、体重、メモ）
    * 統計情報（平均値、最大/最小値、記録期間）
    * 血圧分類の分布
    * ユーザーが設定した備考（通院情報、服薬状況など）
* **ストリーミング表示**: AIの生成テキストをリアルタイムで徐々に表示する（SSE）。
* **会話継続（壁打ち）**: 診断後に追加質問を入力して、会話を継続した追加相談ができる。
    * チャット形式のUI（ユーザー発言とAI応答が交互に表示）
    * 会話履歴は全てコンテキストとして保持される
* **提案質問（サジェスト）**: AIの回答の最後に、ユーザーが次に質問できる候補を3つ提示する。
    * AIレスポンス内に `{{SUGGEST:質問テキスト}}` フォーマットで質問候補を含める
    * 質問候補はクリック可能なボタンとして表示される
    * ボタンをクリックすると、その質問がフォローアップとして送信される
    * 新しいAI応答が来ると、前回の提案ボタンは非表示になる
* **注意表示**: AI診断は医療行為ではなく参考情報である旨の注意書きを常時表示する。

### 3.8 AI向け備考設定
設定タブにAI診断に含める備考情報の入力欄を設ける。
* **保存先**: localStorage
* **内容例**: 高血圧の治療で通院中、降圧剤を服用中、持病の情報など
* **用途**: AI診断のプロンプトに含めることで、より個別化されたアドバイスを得られる

## 4. 非機能要件

### 4.1 動作環境
* **ブラウザ**: Google Chrome, Safari, Firefox, Edge等のモダンブラウザ最新版。
* **デバイス**: PC、タブレット、スマートフォン（レスポンシブデザイン対応）。

### 4.2 パフォーマンス
* データの保存・読み込みは瞬時（1秒未満）に完了すること。
* 1000件以上のデータでもスムーズに動作すること。

### 4.3 セキュリティ・プライバシー
* 全データはブラウザ内（IndexedDB）にのみ保存し、外部サーバーへの送信は一切行わない。
* エクスポートファイルはユーザーのローカルストレージに保存される。

### 4.4 保守性
* Dockerコンテナによる環境構築手順が整備されていること。
* 計算ロジックとUI表示ロジックが分離されていること。
* ドキュメント駆動開発により、仕様・テスト観点が明確であること。
