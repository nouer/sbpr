# 詳細設計書

## 1. IndexedDB操作

### 1.1 データベース初期化
```javascript
// DB名: sbpr_db, バージョン: 1
// オブジェクトストア: bp_records
//   keyPath: "id"
//   インデックス: measuredAt (unique: false)
```

### 1.2 CRUD操作
* **Create**: `addRecord(record)` - 新規レコード追加
* **Read**: `getAllRecords()` - 全件取得（measuredAt降順）
* **Read**: `getRecordsByDateRange(from, to)` - 期間指定取得
* **Update**: `updateRecord(record)` - 既存レコード更新
* **Delete**: `deleteRecord(id)` - 個別削除
* **Delete**: `deleteAllRecords()` - 全件削除

## 2. レコード構造とバリデーション

### 2.1 レコード構造の詳細
* **id**: UUID v4文字列（自動生成）
* **measuredAt**: ISO 8601形式の日時文字列
* **systolic**: 最高血圧（整数, 50〜300）
* **diastolic**: 最低血圧（整数, 30〜200）
* **pulse**: 脈拍数（整数, 30〜250, null可）
* **mood**: 気分（整数, 1=悪い, 2=普通, 3=良い, null=未選択）
* **condition**: 体調（整数, 1=悪い, 2=普通, 3=良い, null=未選択）
* **weight**: 体重（浮動小数点数, 20.0〜300.0, 小数点1桁まで, null=未選択）
* **memo**: メモ（文字列, null可）
* **createdAt**: 作成日時（ISO 8601形式）
* **updatedAt**: 更新日時（ISO 8601形式）

### 2.2 バリデーション仕様
* **systolic**: 50〜300の整数、かつ systolic > diastolic
* **diastolic**: 30〜200の整数
* **pulse**: 30〜250の整数（入力時のみ検証、null可）
* **weight**: 20.0〜300.0の浮動小数点数、小数点1桁まで（入力時のみ検証、null可）
* **mood**: 1, 2, 3, または null
* **condition**: 1, 2, 3, または null

## 3. 計算ロジック (bp.calc.js)

### 3.1 血圧分類
WHO/ISH基準に基づく血圧分類:
* 正常: 収縮期 < 120 かつ 拡張期 < 80
* 正常高値: 収縮期 120-129 かつ 拡張期 < 80
* 高値血圧: 収縮期 130-139 または 拡張期 80-89
* I度高血圧: 収縮期 140-159 または 拡張期 90-99
* II度高血圧: 収縮期 160-179 または 拡張期 100-109
* III度高血圧: 収縮期 >= 180 または 拡張期 >= 110

### 3.2 統計計算
* `calcAverage(records)` - 平均値算出
* `calcMinMax(records)` - 最大/最小値算出
* `classifyBP(systolic, diastolic)` - 血圧分類判定

## 4. エクスポート/インポート

### 4.1 エクスポート形式
```json
{
  "version": "1.0.0",
  "appName": "sbpr",
  "exportedAt": "2026-01-15T12:00:00.000Z",
  "recordCount": 100,
  "records": [ ... ],
  "profile": {
    "birthday": "1980-01-15",
    "gender": "male",
    "height": "170"
  },
  "aiMemo": "高血圧の家族歴あり。降圧剤を服用中。"
}
```

#### フィールド説明
| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| version | string | 必須 | アプリバージョン |
| appName | string | 必須 | 固定値 "sbpr" |
| exportedAt | string | 必須 | エクスポート日時（ISO 8601） |
| recordCount | number | 必須 | レコード件数 |
| records | array | 必須 | 血圧記録の配列 |
| profile | object | 任意 | プロフィール情報（後方互換のため任意） |
| profile.birthday | string | 任意 | 生年月日（YYYY-MM-DD形式） |
| profile.gender | string | 任意 | 性別（"male" / "female" / "other" / ""） |
| profile.height | string | 任意 | 身長（cm） |
| aiMemo | string | 任意 | AIに伝えたい備考（後方互換のため任意） |

#### 後方互換性
* `profile` と `aiMemo` はオプショナルフィールド
* 旧バージョンのエクスポートファイル（`profile`/`aiMemo`なし）もインポート可能
* 旧バージョンのアプリでインポートしても `profile`/`aiMemo` は無視されるだけで動作に影響なし

### 4.2 インポート処理
1. ファイル読み込み (FileReader API)
2. JSON パース
3. バリデーション（形式チェック）
4. 既存データとのマージ（IDベースで重複排除）
5. IndexedDBに一括書き込み
6. `profile` が存在すればlocalStorageのプロフィール情報を上書き復元
7. `aiMemo` が存在すればlocalStorageのAI備考を上書き復元
8. 復元後、UIの入力フィールドに反映

## 5. グラフ描画

### 4.1 Chart.js設定
* タイプ: line
* データセット: 最高血圧(赤系), 最低血圧(青系), 脈拍(緑系)
* 基準線: annotation pluginで描画
* X軸: 時系列（date adapter使用）
* Y軸: mmHg / bpm

## 6. AI診断機能

### 6.1 API通信（OpenAI reverse proxy）

ブラウザから `api.openai.com` を直接呼び出すとCORSでブロックされるため、
同一オリジンのプロキシ経由で中継する。

#### 経路
| 環境 | クライアント → | → upstream |
|------|---------------|------------|
| ローカル (nginx) | `/openai/*` | `api.openai.com/*` |
| Vercel (rewrite) | `/openai/:path*` → `/api/openai?path=:path*` | `api.openai.com/:path*` |

#### クライアント側フォールバック
Vercelの設定差異（Root Directory等）によりrewriteが機能しない場合に備え、
クライアント（`script.js`）は以下の順に試行する:
1. `/openai/v1/chat/completions`（vercel.json rewrite経由）
2. 404の場合 → `/api/openai?path=v1/chat/completions`（Function直接呼び出し）

#### プロキシ実装（3ファイル構成）
| ファイル | 用途 |
|---------|------|
| `api/openai.js` | Vercel Function（クエリパラメータ `?path=` 方式） |
| `api/openai/[...path].js` | Vercel Function（catch-all route方式、フォールバック用） |
| `local_app/api/openai.js` | Vercel Root Directory が `local_app` の場合用 |

* **OPTIONS preflight**: 204を返却（同一オリジンなら通常不要だが環境差を吸収）
* **バリデーション**: `path` パラメータと `Authorization` ヘッダの欠落時は 400 を返却
* **リクエスト転送**: `req`（IncomingMessage）をそのまま `body` に渡し、`duplex: 'half'` で
  ストリームとして転送（`JSON.stringify` による再シリアライズは行わない）
* **ヘッダ転送**: クライアントの `authorization`, `content-type`, `accept` のみ上流へ転送
* **レスポンス転送**: `Readable.fromWeb(upstreamRes.body).pipe(res)` で
  Web ReadableStream → Node stream 変換し効率的にストリーミング転送
* **ステータス透過**: upstream の HTTP ステータスコードをそのまま返却
* **エラー処理**: upstream 接続失敗時は 502 (Bad Gateway) を返却

#### モデル選択
* 設定タブの「利用モデル」セレクトボックスでユーザーが選択可能
* デフォルト: `gpt-4o-mini`（コスト効率重視）
* 選択肢は `AI_MODEL_CATALOG` で定義:

| model id | 表示名 | コンテキスト上限 | 入力単価/1M | 出力単価/1M |
|----------|--------|-----------------|------------|------------|
| `gpt-4o-mini` | GPT-4o mini（低コスト） | 128,000 | $0.15 | $0.60 |
| `gpt-4.1-mini` | GPT-4.1 mini | 1,047,576 | $0.40 | $1.60 |
| `gpt-4.1` | GPT-4.1（1Mコンテキスト） | 1,047,576 | $2.00 | $8.00 |
| `gpt-4o` | GPT-4o | 128,000 | $2.50 | $10.00 |
| `gpt-5-mini` | GPT-5 mini（高速） | 400,000 | $1.10 | $4.40 |
| `gpt-5` | GPT-5 | 400,000 | $2.00 | $8.00 |
| `gpt-5.2` | GPT-5.2（最新） | 400,000 | $2.00 | $8.00 |

* 選択値は `localStorage` キー `sbpr_ai_model` に自動保存
* `getSelectedAiModel()` で取得、`setSelectedAiModel(modelId)` で保存
* カタログに存在しない値が保存されている場合はデフォルト（`gpt-4o-mini`）にフォールバック
* エクスポート/インポートにもモデル設定を含む

#### ストリーミング
* SSE（Server-Sent Events）でリアルタイム表示

### 5.2 プロンプト構築
```
システムプロンプト:
あなたは血圧管理の健康アドバイザーです。
ユーザーの血圧測定データに基づいて、わかりやすいアドバイスを提供してください。
医療行為ではなく、一般的な健康アドバイスとして回答してください。

ユーザープロンプト:
【血圧測定データ】
{記録データを日時順にフォーマット（日時、最高/最低血圧、脈拍、気分、体調、体重、メモ）}

【統計情報】
{平均値、最大/最小値、記録件数}

【ユーザー備考】
{設定の備考欄の内容}

上記のデータに基づいて、血圧の傾向分析と健康アドバイスをお願いします。
```

### 5.3 会話継続
* messages配列にassistant/userのロールで会話を蓄積
* 追加質問時は全履歴をコンテキストとして送信
* UIはチャット形式で表示

### 5.4 提案質問（サジェスト）機能
* AIレスポンスの末尾に `{{SUGGEST:質問テキスト}}` 形式で質問候補を3つ含める
* `parseSuggestions(content)` で本文と質問候補を分離
  * 戻り値: `{ mainContent: string, suggestions: string[] }`
* ストリーミング中は候補マーカーを非表示にし、完了後にボタンとして描画
* ボタンクリック時は `sendSuggestion(text)` で該当テキストをフォローアップ送信
* 会話復元時は最後のアシスタントメッセージから候補を再描画
* 新しいAI応答が生成されると前回の候補ボタンは消える

### 5.5 設定データ保存（localStorage）
* `sbpr_openai_api_key`: APIキー
* `sbpr_ai_model`: 利用モデルID（デフォルト: `gpt-4o-mini`）
* `sbpr_ai_memo`: AI向け備考

### 6.2 AI API 使用量・コスト見積もり

本アプリのAI診断機能（gpt-4o-mini）を使用した場合のトークン消費量と料金を見積もる。

#### 料金体系（2026年2月時点）

| 項目 | 料金 |
|------|------|
| 入力トークン | $0.150 / 100万トークン |
| 出力トークン | $0.600 / 100万トークン |
| キャッシュ済み入力 | $0.075 / 100万トークン |

> **出典**: [OpenAI API Pricing](https://platform.openai.com/docs/pricing)（2026年2月15日確認）
> **出典**: [GPT 4o mini API Pricing 2026 - pricepertoken.com](https://pricepertoken.com/pricing-page/model/openai-gpt-4o-mini)

#### 日本語テキストのトークン換算

| 種別 | 概算トークン数/文字 | 備考 |
|------|---------------------|------|
| 日本語1文字（漢字・ひらがな・カタカナ） | 1〜1.2 トークン | 句読点・記号を含めると増加 |
| 日本語文章（平均） | 1文字 ≒ 1.1トークン | 長文サンプルからの平均値 |

> **出典**: [OpenAI: GPT-4o mini の料金計算ロジック - Qiita](https://qiita.com/Web_akira/items/0a307b8b0baa92b0216e)（2025年4月）
> **出典**: [OpenAI の GPT-4o と GPT-4 Turbo のトークン数比較 - gotohayato.com](https://gotohayato.com/content/576/)

100万トークン ÷ 1.1 ≒ 約90万文字の日本語に相当する。

#### 本アプリのプロンプト構成とトークン数

##### システムプロンプト（毎回送信）

`buildSystemPrompt()` の内容は約280文字（日本語）→ **約310トークン**

##### ユーザープロンプト（初回診断時）

`buildDataSummary()` で構築されるデータプロンプトのサイズは記録件数に依存する。

| 記録件数 | プロンプトサイズ（概算） | トークン数（概算） |
|----------|--------------------------|---------------------|
| 0件（データなし） | 約50文字 | 約55トークン |
| 10件 | 約800文字 | 約880トークン |
| 30件（典型的） | 約2,200文字 | 約2,400トークン |
| 50件（上限） | 約3,700文字 | 約4,100トークン |

※ 各レコードは「日時 | 最高/最低血圧 (分類) | 脈拍 | 体重 | 気分 | 体調 | メモ」形式で約65文字/件。
※ 統計情報・血圧分類分布・プロフィール・AI備考を含む。

##### AI応答（出力）

`max_tokens: 2000` に設定。典型的な応答は800〜1,500トークン程度。
初回診断（詳細分析+アドバイス）は約1,200トークン、フォローアップ応答は約800トークンが目安。

#### 1セッション（10回のやりとり）のトークン消費量シミュレーション

**前提条件**:
- 記録件数: 30件（典型的な利用者）
- 初回診断1回 + フォローアップ質問9回
- フォローアップ質問: 約50文字/回 → 約55トークン/回
- 会話履歴は全てコンテキストとして毎回送信される（`sendFollowUp()` の実装による）

| 呼び出し | 入力トークン（累積） | 出力トークン | 備考 |
|----------|----------------------|--------------|------|
| 1回目（初回診断） | 約3,000 | 約1,200 | system + データプロンプト |
| 2回目 | 約4,300 | 約800 | +前回応答+質問 |
| 3回目 | 約5,200 | 約800 | 会話履歴が累積 |
| 4回目 | 約6,100 | 約800 | |
| 5回目 | 約6,900 | 約800 | |
| 6回目 | 約7,800 | 約800 | |
| 7回目 | 約8,600 | 約800 | |
| 8回目 | 約9,500 | 約800 | |
| 9回目 | 約10,300 | 約800 | |
| 10回目 | 約11,200 | 約800 | |
| **合計** | **約73,000** | **約8,400** | |

※ フォローアップ時にデータ更新がある場合、追加のデータプロンプト（約2,400トークン）が挿入されるため、これより多くなる可能性がある。

#### コスト計算

##### 1セッション（10回のやりとり）あたり

| 項目 | トークン数 | 単価 | コスト (USD) | コスト (JPY) |
|------|------------|------|-------------|-------------|
| 入力 | 73,000 | $0.15/1M | $0.01095 | 約1.64円 |
| 出力 | 8,400 | $0.60/1M | $0.00504 | 約0.76円 |
| **合計** | **81,400** | — | **$0.01599** | **約2.40円** |

※ 為替レート: 1 USD = 150 JPY で計算

##### 月間利用パターン別コスト

| 利用頻度 | セッション数/月 | 月間トークン | 月額コスト (USD) | 月額コスト (JPY) |
|----------|----------------|-------------|-----------------|-----------------|
| 毎日1回 | 30回 | 約2,442,000 | 約$0.48 | 約72円 |
| 週2回 | 8回 | 約651,200 | 約$0.13 | 約19円 |
| 週1回 | 4回 | 約325,600 | 約$0.06 | 約10円 |
| 月2回 | 2回 | 約162,800 | 約$0.03 | 約5円 |

##### 年間コスト見込み（毎日1回利用の場合）

| 項目 | 金額 |
|------|------|
| 年間（USD） | 約$5.76 |
| 年間（JPY, 150円/USD） | 約864円 |

#### 参考: 他のモデルとのコスト比較

本アプリは `gpt-4o-mini` を採用しており、他のモデルと比較して大幅にコストを抑えている。

| モデル | 入力単価/1M | 出力単価/1M | 10回セッション1回分 |
|--------|------------|------------|-------------------|
| **gpt-4o-mini（採用中）** | **$0.15** | **$0.60** | **約$0.016（約2.4円）** |
| gpt-4o | $2.50 | $10.00 | 約$0.27（約40円） |
| gpt-4.1 | $2.00 | $8.00 | 約$0.21（約32円） |
| gpt-4.1-mini | $0.40 | $1.60 | 約$0.04（約6円） |

> **出典**: [OpenAI API Pricing](https://platform.openai.com/docs/pricing)（2026年2月15日確認）

#### まとめ

- **gpt-4o-mini は極めて低コスト**: 1回のAIセッション（10往復）で約2.4円
- **毎日使っても月額約72円**: 個人利用では実質的なコスト負担はほぼゼロ
- **ユーザー自身のAPIキーを使用**: Vercel側の課金は発生しない（プロキシのみ）
- **会話履歴の累積が主なコスト要因**: フォローアップ回数が増えるほど入力トークンが増加する
- **記録件数50件上限**: `buildDataSummary()` で最大50件に制限しており、極端なトークン消費を防止
